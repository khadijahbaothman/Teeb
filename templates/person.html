{% extends 'base.html' %}
{% block title %}ملخص التاريخ الطبي{% endblock %}

{% block content %}

<section class="person-wrap">

  <!-- شارة وسط (اختياري: static/badge.png) -->
  <div class="center-badge">
    <img src="{{ url_for('static', filename='badge.png') }}" alt="badge" onerror="this.style.display='none'">
  </div>

  <!-- الكرت الرئيسي -->
  <div class="person-sheet card glass">
    <h1 class="person-heading">ملخص التاريخ الطبي </h1>
    <!-- الهيدر: علم + جنسية | اسم + رقم نسك | أفاتار -->
    <div class="header-row">
      <div class="left-flag">
        {% if flag_url %}
          <img class="flag" src="{{ flag_url }}" alt="flag" crossorigin="anonymous" referrerpolicy="no-referrer">
        {% else %}
          <div class="flag fallback">🌍</div>
        {% endif %}
        <div class="nat-label">{{ rec.get("Nationality","—") }}</div>
      </div>

      <div class="id-block">
        <div class="name">{{ rec.get("Full Name","—") }}</div>
        <div class="nusuk-box">
          رقم نسك: {{ rec.get("Nusuk ID","—") }}
        </div>
        <div class="subline" dir="rtl">
          <span>العمر: {{ rec.get("Age","—") }}</span>
          <span class="dot">•</span>
          <span>رقم الجوال: {{ rec.get("Phone","—") }}</span>
          {% if rec.get("Blood Type") %}
            <span class="dot">•</span>
            <span>فصيلة الدم: {{ rec.get("Blood Type") }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <hr class="soft-divider">

    <!-- شبكة الأقسام -->
    <div class="grid-two">
      <!-- الأمراض المزمنة -->
      <div class="section">
        <h3 class="sec-title">الأمراض المزمنة</h3>
        <div class="tag-list">
          {% set chronic_str = rec.get("Chronic Conditions","") %}
          {% set any_tag = False %}
          {% for raw in chronic_str.split("،") if raw.strip() %}
            {% set any_tag = True %}
            {% set item = raw.strip() %}
            {% if item.startswith("أخرى") %}
              {% set parts = item.split(":", 1) %}
              {% set val = parts[1].strip() if parts|length > 1 else "أخرى" %}
              <span class="tag">{{ val }}</span>
            {% else %}
              <span class="tag">{{ item }}</span>
            {% endif %}
          {% endfor %}
          {% if not any_tag %}
            <span class="tag tag-empty">لا يوجد</span>
          {% endif %}
        </div>
      </div>

      <!-- الحساسية -->
      <div class="section">
        <h3 class="sec-title">الحساسية</h3>
        <div class="tag-list">
          {% set allergies_str = rec.get("Allergies","") %}
          {% set any_tag = False %}
          {% for raw in allergies_str.split("،") if raw.strip() %}
            {% set any_tag = True %}
            {% set item = raw.strip() %}
            {% if item.startswith("أخرى") %}
              {% set parts = item.split(":", 1) %}
              {% set val = parts[1].strip() if parts|length > 1 else "أخرى" %}
              <span class="tag">{{ val }}</span>
            {% else %}
              <span class="tag">{{ item }}</span>
            {% endif %}
          {% endfor %}
          {% if not any_tag %}
            <span class="tag tag-empty">لا يوجد</span>
          {% endif %}
        </div>
      </div>

      <!-- الأدوية الحالية -->
      <div class="section">
        <h3 class="sec-title">الأدوية الحالية</h3>
        <ul class="dot-list">
          {% for line in (rec.get("Current Meds","").splitlines()) if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
          {% if not rec.get("Current Meds") %}<li class="muted">—</li>{% endif %}
        </ul>
      </div>

      <!-- التطعيمات -->
      <div class="section">
        <h3 class="sec-title">التطعيمات</h3>
        <ul class="dot-list">
          {% for line in (rec.get("Vaccinations","").splitlines()) if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
          {% if not rec.get("Vaccinations") %}<li class="muted">—</li>{% endif %}
        </ul>
      </div>
    </div>

    {% if rec.get("Medical Notes") %}
      <div class="section">
        <h3 class="sec-title">ملاحظات خاصة</h3>
        <ul class="dot-list">
          {% for line in rec.get("Medical Notes","").splitlines() if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- أزرار أسفل -->
    <div class="sheet-actions">
      <button class="btn btn-danger" id="panicBtn" type="button">
        طلب المساعدة / الدعم
      </button>
      <button class="btn btn-dark" onclick="window.print()">طباعة</button>
    </div>

  </div>
</section>

<script>
  document.getElementById('panicBtn')?.addEventListener('click', () => {
    const supportNumber = "966555000000"; // غيّريه لرقم الطوارئ الحقيقي
  
    const name = "{{ rec.get('Full Name', '—') }}";
    const nusuk = "{{ rec.get('Nusuk ID', '—') }}";
    const age = "{{ rec.get('Age', '—') }}";
    const nationality = "{{ rec.get('Nationality', '—') }}";
    const phone = "{{ rec.get('Phone', '—') }}";
    const blood = "{{ rec.get('Blood Type', '—') }}";
    const chronic = `{{ rec.get('Chronic Conditions', '—') }}`.replace(/\n/g, ', ');
    const allergy = `{{ rec.get('Allergies', '—') }}`.replace(/\n/g, ', ');
    const meds = `{{ rec.get('Current Meds', '—') }}`.replace(/\n/g, ', ');
  
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
  
          const message =
            `🚨 *طلب مساعدة عاجل لحاج*\n\n` +
            `👤 الاسم: ${name}\n` +
            `🪪 رقم نسك: ${nusuk}\n` +
            `📱 رقم الجوال: ${phone}\n` +
            `🌍 الجنسية: ${nationality}\n` +
            `🧍‍♂️ العمر: ${age}\n` +
            (blood && blood !== "—" ? `🩸 فصيلة الدم: ${blood}\n` : "") +
            `\n⚕️ *الأمراض المزمنة:* ${chronic}\n` +
            `💊 *الأدوية الحالية:* ${meds}\n` +
            `🌿 *الحساسية:* ${allergy}\n\n` +
            `📍 *موقع الحاج:* ${mapsLink}\n\n` +
            `🔴 الرجاء التعامل مع الحالة فورًا.`;
  
          const waURL = `https://wa.me/${supportNumber}?text=${encodeURIComponent(message)}`;
          window.open(waURL, "_blank");
        },
        (error) => {
          alert("لم نتمكن من تحديد موقعك. تأكد من تفعيل الموقع وحاول مجددًا.");
          sendWithoutLocation();
        }
      );
    } else {
      alert("جهازك لا يدعم تحديد الموقع الجغرافي.");
      sendWithoutLocation();
    }
  
    function sendWithoutLocation() {
      const message =
        `🚨 *طلب مساعدة عاجل لحاج (بدون موقع)*\n\n` +
        `👤 الاسم: ${name}\n` +
        `🪪 رقم نسك: ${nusuk}\n` +
        `📱 رقم الجوال: ${phone}\n` +
        `🌍 الجنسية: ${nationality}\n` +
        `🧍‍♂️ العمر: ${age}\n` +
        (blood && blood !== "—" ? `🩸 فصيلة الدم: ${blood}\n` : "") +
        `\n⚕️ *الأمراض المزمنة:* ${chronic}\n` +
        `💊 *الأدوية الحالية:* ${meds}\n` +
        `🌿 *الحساسية:* ${allergy}\n\n` +
        `⚠️ لم يتم إرسال الموقع.`
  
      const waURL = `https://wa.me/${supportNumber}?text=${encodeURIComponent(message)}`;
      window.open(waURL, "_blank");
    }
  });
  </script>

<style>
/* ===== PERSON PAGE LAYOUT (inline for convenience) ===== */
.person-wrap{ margin-top: 10px; }
.person-heading{ text-align:center; font-size:28px; font-weight:900; margin:0 0 10px; color: #34B8EC;}
.center-badge{ display:flex; justify-content:center; margin-bottom:10px; }
.center-badge img{ height:56px; width:auto; }

.person-sheet{
  position: relative;
  background:#fff; border:1px solid var(--border);
  border-radius:28px; padding:22px 20px;
  box-shadow:0 18px 40px rgba(0,0,0,.08);
  z-index: 50;
}

/* header block */
.header-row{
  display:grid; grid-template-columns: 140px 1fr 70px; gap:16px; align-items:center ;
}
.left-flag{ display:flex; align-items:center; gap:10px; }
.flag{ width:62px; height:42px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb; }
.flag.fallback{ width:62px; height:42px; display:flex; align-items:center; justify-content:center; background:#f1f5f9; border:1px solid #e5e7eb; border-radius:6px; font-size:22px; }
.nat-label{ font-weight:800; color:#111827; }

.id-block .name{ font-size:22px; font-weight:900; line-height:1.25;}
.id-block .hid{ color:#6b7280; font-weight:700; margin-top:4px; }
.id-block .subline{ margin-top:6px; color:#374151; font-weight:700; display:flex; gap:8px; flex-wrap:wrap; }
.subline .dot{ opacity:.5 }

.avatar{
  width:54px; height:54px; border-radius:50%;
  background:#f3f4f6; display:flex; align-items:center; justify-content:center;
  font-size:24px; border:1px solid #e5e7eb;
}
.id-block .subline{
  direction: rtl;              /* يضمن الترتيب يمين→يسار */
  display:flex; flex-wrap:wrap;
  gap: 12px;                   /* مسافة بين العناصر */
  color:#374151; font-weight:700; margin-top:6px;
}
.subline span{ white-space: nowrap; }
.subline .dot{ opacity:.5; margin: 0 2px; }

.soft-divider{ border:none; border-top:1px solid #eef2f7; margin:14px 0 12px; }

/* sections grid */
.grid-two{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:18px; }
.sec-title{ font-size:20px; font-weight:900; margin:0 0 8px; color:#111827; }

/* tag boxes (pills) */
.tag-list{ display:flex; flex-wrap:wrap; gap:8px; }
.tag{
  background:#ecfeff; color:#0369a1; border:1.5px solid #67e8f9;
  padding:6px 12px; border-radius:999px; font-weight:800; font-size:14px;
}
.tag-empty{ background:#f3f4f6; border-color:#e5e7eb; color:#6b7280; }

/* dot lists */
.dot-list{ margin:0; padding-inline-start: 1.2rem; }
.dot-list li{ margin:6px 0; }

/* bottom actions */
.sheet-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:16px; }
.btn{ border-radius:16px; padding:10px 16px; font-weight:900; border:1px solid transparent; cursor:pointer; }
.btn-dark{ background:#111827; color:#fff; }
.btn-dark:hover{ background:#0b1220; }
.btn-danger{ background:#ef4444; color:#fff; box-shadow:0 10px 20px rgba(239,68,68,.24); }
.btn-danger:hover{ background:#dc2626; }

.card.glass {
  background: rgba(255, 255, 255, .75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, .55);
}

.nusuk-box {
  position: absolute;
  left: 24px;
  top: 18px;
  background: #ecfeff;
  color: #0369a1;
  border: 2px solid #34B8EC;
  border-radius: 14px;
  padding: 6px 16px;
  font-weight: 800;
  font-size: 16px;
  box-shadow: 0 2px 6px rgba(3,105,161,.12);
  white-space: nowrap; /* يمنع النص من الانقسام */
}

/* 🎯 تعديل تلقائي على الشاشات الصغيرة */
@media (max-width: 640px) {
  .nusuk-box {
    position: relative;  /* يخليه داخل التدفق بدل الزاوية */
    left: auto;
    top: auto;
    margin: 10px auto 6px auto; /* يوسّطه فوق الاسم */
    display: inline-block;
    font-size: 15px;
  }
}
/* responsive */
@media (max-width: 820px){
  .header-row{ grid-template-columns: 1fr 1fr; }
  .avatar{ grid-column: 2 / 3; justify-self:end; }
  .grid-two{ grid-template-columns: 1fr; }
}

/* print clean */
@media print{
  header.nav, .footer { display:none !important; }
  body{ background:#fff !important; }
  .person-sheet{ box-shadow:none; border:1px solid #ddd; }
  .sheet-actions{ display:none !important; }
}
/* ===== Mobile & small screens fixes ===== */
@media (max-width: 640px){
  /* الكرت نفسه */
  .person-sheet{
    padding: 16px 14px;
    border-radius: 20px;
    overflow: hidden;
  }

  /* العنوان الأعلى */
  .person-heading{ font-size: 24px; margin-bottom: 6px; }

  /* الهيدر: خليه عمود واحد */
  .header-row{
    grid-template-columns: 1fr;
    gap: 10px;
    align-items: flex-start;
  }

  /* صندوق رقم نسك: داخل التدفق وتحت العنوان مباشرة */
  .nusuk-box{
    position: relative;
    left: auto; top: auto;
    margin: 6px 0 4px 0;
    display: inline-block;
    font-size: 15px;
  }

  /* الاسم والمعرّف */
  .id-block .name{ font-size: 20px; }
  .id-block .hid{ font-size: 13px; }

  /* سطر (العمر • الجوال • الدم) */
  .id-block .subline{
    font-size: 14px;
    gap: 8px;
    flex-wrap: wrap;
  }
  .id-block .subline span{ white-space: nowrap; } /* يمنع تكسير الكلمات */

  /* العلم والجنسية */
  .left-flag{ order: 3; justify-content: flex-start; }
  .flag{ width: 56px; height: 36px; }

  /* الفاصل */
  .soft-divider{ margin: 10px 0; }

  /* شبكة الأقسام: عمود واحد */
  .grid-two{ grid-template-columns: 1fr; gap: 14px; }

  /* العناوين والتاغات أصغر */
  .sec-title{ font-size: 18px; }
  .tag{ font-size: 13px; padding: 6px 10px; }
  .tag-list{ gap: 6px; }

  /* القوائم النقطية */
  .dot-list{ padding-inline-start: 1rem; }

  /* الأزرار بالأسفل تمتلئ العرض وتترتب عمودي */
  .sheet-actions{
    flex-direction: column;
    gap: 8px;
  }
  .sheet-actions .btn{
    width: 100%;
    text-align: center;
  }
}

/* تابلت صغير */
@media (min-width: 641px) and (max-width: 820px){
  .person-sheet{ padding: 18px 16px; }
  .header-row{ grid-template-columns: 140px 1fr; }
  .grid-two{ grid-template-columns: 1fr 1fr; gap: 16px; }
  .tag{ font-size: 13.5px; }
}
</style>

{% endblock %}