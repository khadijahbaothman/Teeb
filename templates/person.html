{% extends 'base.html' %}
{% block title %}ملخص التاريخ الطبي للحاج{% endblock %}

{% block content %}
<section class="person-wrap">
  <div class="person-sheet card glass">

      <!-- عنوان -->
      <h1 class="person-heading">ملخص التاريخ الطبي </h1>

    <!-- شعار طيب الأعلى (عدّلي اسم الملف إن لزم) -->
    <div class="top-logo">
      <img src="{{ url_for('static', filename='logo33.png') }}" alt="Tayyeb" onerror="this.style.display='none'">
    </div>


    <!-- شارة رقم نسك (بوكس) -->
    <div class="nusuk-box">رقم نسك: {{ rec.get("Nusuk ID","—") }}</div>

    <!-- هيدر البطاقة -->
    <div class="header-row persona">
      <!-- يسار: علم + جنسية -->


      <!-- وسط/يمين: اسم -->
      <div class="id-block">
        <div class="name">{{ rec.get("Full Name","—") }}</div>
      </div>
 <div class="left-flag">
        {% if flag_url %}
          <img class="flag" src="{{ flag_url }}" alt="flag" crossorigin="anonymous" referrerpolicy="no-referrer">
        {% else %}
          <div class="flag fallback">🌍</div>
        {% endif %}
        <div class="nat-label">{{ rec.get("Nationality","—") }}</div>
      </div>
    </div>

    <!-- شارة العمر وفصيلة الدم -->
    <div class="badges-row">
      <span class="pill pill-red">فصيلة الدم: {{ rec.get("Blood Type","—") }}</span>
      <span class="pill pill-dark">العمر: {{ rec.get("Age","—") }}</span>
    </div>

    <hr class="soft-divider">

    <!-- تفاصيل البطاقة (مخفية حتى الضغط على طيب والتحقق) -->
 <!-- تفاصيل البطاقة (مخفية حتى الضغط على طيب والتحقق) -->
<div class="details-wrap">

  <!-- 1) الأدوية الحالية -->
  <div class="section">
    <h3 class="sec-title strong">الأدوية الحالية</h3>

    {% if rec.get("Meds Photo") %}
      <!-- عند وجود صورة: نعرض اللستة الثابتة -->
      <ul class="dot-list">
        <li>💊 Glucophage (ميتفورمين 500 مجم)</li>
        <li>💊 Aspirin Protect 100 (أسبرين بروتكت 100 مجم)</li>
        <li>💊 Amlor (أملور 5 مجم)</li>
      </ul>
    {% else %}
      <!-- بدون صورة: نعرض ما اختاره/كتبه المستخدم -->
      <ul class="dot-list">
        {% if rec.get("Current Meds") %}
          {% for line in rec.get("Current Meds","").splitlines() if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
        {% else %}
          <li class="muted">—</li>
        {% endif %}
      </ul>
    {% endif %}
  </div>

  <!-- 2) الأمراض المزمنة -->
  <div class="section">
    <h3 class="sec-title strong">الأمراض المزمنة</h3>
    <div class="tag-list">
      {% set chronic_txt = (rec.get("Chronic Conditions","") or "").replace('\n','،') %}
      {% set has_any = false %}
      {% for item in chronic_txt.split("،") if item.strip() %}
        {% set has_any = true %}
        <span class="tag">{{ item.strip() }}</span>
      {% endfor %}
      {% if not has_any %}
        <span class="tag tag-empty">—</span>
      {% endif %}
    </div>
  </div>

  <!-- 3) صورة الدواء (الأخير) -->
  {% if rec.get("Meds Photo") %}
    <div class="section">
      <h3 class="sec-title strong">صورة الدواء</h3>
      <img src="{{ url_for('uploaded_file', fname=rec['Meds Photo']) }}"
           alt="صورة الدواء" class="meds-img">
    </div>
  {% endif %}

</div>

    <!-- أزرار أسفل (زر طيب + طباعة) -->
    <div class="sheet-actions">
      <button id="okBtn" class="btn btn-ok">فريق طِيب</button>
      <button class="btn btn-dark" onclick="window.print()">طباعة</button>
    </div>

  </div>
</section>

<!-- ===== بوب-أب التحقق + إظهار التفاصيل ===== -->
<script>
(function () {
  // زر "طيب" → يفتح بوب-أب للتحقق ثم يُظهر التفاصيل
  document.getElementById('okBtn')?.addEventListener('click', showPopup);

  function showPopup(){
    const overlay = document.createElement("div");
    overlay.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,.7);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    `;
    overlay.innerHTML = `
      <div style="
        background:#fff; padding:30px; border-radius:20px;
        box-shadow:0 10px 40px rgba(0,0,0,.3); text-align:center;
        max-width:320px; width:90%; font-family:'Tajawal',sans-serif;
      ">
        <h2 style="margin-bottom:14px; font-size:20px;">التحقق من الصلاحية</h2>
        <p style="margin-bottom:16px; color:#444;">أدخل الرقم السري لعرض كامل البيانات</p>
        <input type="password" id="idInput" placeholder="•••••"
          style="width:100%; padding:10px; border:1px solid #ccc; border-radius:12px; text-align:center; font-size:16px;">
        <div id="errorMsg" style="color:#ef4444; margin-top:8px; display:none;">❌ الرقم غير صحيح</div>
        <button id="submitId"
          style="margin-top:16px; background:#0f766e; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer;">
          تحقق
        </button>
      </div>
    `;
    document.body.appendChild(overlay);

    const correctCode = "99999";
    const doCheck = () => {
      const input = document.getElementById("idInput").value.trim();
      const error = document.getElementById("errorMsg");
      if (input === correctCode) {
        overlay.remove();
        const details = document.querySelector(".details-wrap");
        if (details){ details.style.display = "grid"; details.classList.add("reveal"); }
        document.getElementById('okBtn')?.remove();
      } else {
        error.style.display = "block";
        setTimeout(()=>{ error.style.display = "none"; }, 1600);
      }
    };
    document.getElementById("submitId").addEventListener("click", doCheck);
    document.getElementById("idInput").addEventListener("keyup", e => { if(e.key==="Enter") doCheck(); });
    document.getElementById("idInput").focus();
  }
})();
</script>

<style>
/* ===== الصفحة والبطاقة ===== */
.person-wrap{ margin-top:10px; }
.person-heading{ text-align:center; font-size:28px; font-weight:900; margin:0 0 10px; color:#111827; }
.person-sheet{
  position:relative; background:#fff; border:1px solid var(--border, #e5e7eb);
  border-radius:28px; padding:24px 20px 20px; box-shadow:0 18px 40px rgba(0,0,0,.08); z-index:50;
}
.card.glass{ background:rgba(255,255,255,.75); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.55); }

/* شعار طيب أعلى */
.top-logo{ display:flex; justify-content:center; margin-bottom:8px; }
.top-logo img{ height:48px; width:auto; }

/* شارة رقم نسك (بوكس) */
.nusuk-box{
  position:absolute; left:22px; top:18px;
  background:#ecfeff; color:#0369a1; border:2px solid #34B8EC;
  border-radius:14px; padding:6px 16px; font-weight:800; font-size:16px;
  box-shadow:0 2px 6px rgba(3,105,161,.12); white-space:nowrap;
}
@media (max-width:640px){
  .nusuk-box{ position:relative; left:auto; top:auto; display:inline-block; margin:6px auto 4px; }
}

/* هيدر */
.header-row.persona{ display:grid; grid-template-columns: 1fr auto auto; gap:14px; align-items:center;  }
.flag{ width:52px; height:36px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb; }
.flag.fallback{ display:flex; align-items:center; justify-content:center; background:#f1f5f9; }
.nat-label{ font-weight:800; color:#111827; }
.id-block .name{ font-size:22px; font-weight:900; line-height:1.2; }
.avatar{ width:46px; height:46px; border-radius:50%; background:#f3f4f6; display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; }
.avatar-icon{ font-size:22px; }

/* بادجات */
.badges-row{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 4px; }
.pill{ display:inline-block; padding:8px 16px; border-radius:999px; font-weight:800; font-size:16px; border:2px solid transparent; }
.pill-red{ background:#ffe4e6; color:#9f1239; border-color:#fecdd3; }
.pill-dark{ background:#0f172a; color:#fff; border-color:#0f172a; }

/* أقسام */
.sec-title{ font-size:20px; font-weight:900; margin:0 0 8px; color:#111827; }
.sec-title.strong{ font-size:26px; }
.sub-sec{ margin:10px 0 6px; font-weight:800; }

.tag-list{ display:flex; flex-wrap:wrap; gap:8px; }
.tag{ background:#ecfeff; color:#0369a1; border:1.5px solid #67e8f9; padding:6px 12px; border-radius:999px; font-weight:800; font-size:14px; }
.tag-empty{ background:#f3f4f6; border-color:#e5e7eb; color:#6b7280; }

.dot-list{ margin:0; padding-inline-start:1.2rem; }
.dot-list li{ margin:6px 0; }
.mt6{ margin-top:6px; }

/* صورة الدواء */
.meds-img{ width:220px; max-width:100%; border-radius:12px; border:1px solid #e5e7eb; }

/* التفاصيل مخفية افتراضياً */
.details-wrap{ display:none; grid-template-columns: 1fr; gap:18px; }
.details-wrap.reveal{ animation: fadeIn .25s ease-in; }
@keyframes fadeIn{ from{opacity:.4} to{opacity:1} }

/* أزرار أسفل */
.sheet-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:16px; }
.btn{ border-radius:16px; padding:10px 16px; font-weight:900; border:1px solid transparent; cursor:pointer; }
.btn-dark{ background:#111827; color:#fff; }
.btn-dark:hover{ background:#0b1220; }
.btn-ok{ background:#34B8EC; color:#fff; border:1px solid #34B8EC; box-shadow:0 6px 16px rgba(52,184,236,.28); }
.btn-ok:hover{ background:#1fa7df; border-color:#1fa7df; }

/* موبايل */
@media (max-width:640px){
  .header-row.persona{ grid-template-columns: 1fr auto; }
  .avatar{ grid-column:2/3; }
  .id-block .name{ font-size:20px; }
  .sec-title.strong{ font-size:22px; }
}
</style>
{% endblock %}