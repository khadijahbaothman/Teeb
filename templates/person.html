{% extends 'base.html' %}
{% block title %}Ù…Ù„Ø®Øµ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ{% endblock %}

{% block content %}

<section class="person-wrap">

  <!-- Ø´Ø§Ø±Ø© ÙˆØ³Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: static/badge.png) -->
  <div class="center-badge">
    <img src="{{ url_for('static', filename='badge.png') }}" alt="badge" onerror="this.style.display='none'">
  </div>

  <!-- Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="person-sheet card glass">
    <h1 class="person-heading">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ</h1>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø¹Ù„Ù… + Ø¬Ù†Ø³ÙŠØ© | Ø§Ø³Ù… + Ø±Ù‚Ù… Ù†Ø³Ùƒ -->
    <div class="header-row">
      <div class="left-flag">
        {% if flag_url %}
          <img class="flag" src="{{ flag_url }}" alt="flag"
               crossorigin="anonymous" referrerpolicy="no-referrer">
        {% else %}
          <div class="flag fallback">ğŸŒ</div>
        {% endif %}
        <div class="nat-label">{{ rec.get("Nationality","â€”") }}</div>
      </div>

      <div class="id-block">
        <div class="name">{{ rec.get("Full Name","â€”") }}</div>
        <div class="nusuk-box">Ø±Ù‚Ù… Ù†Ø³Ùƒ: {{ rec.get("Nusuk ID","â€”") }}</div>
        <div class="subline" dir="rtl">
          <span>Ø§Ù„Ø¹Ù…Ø±: {{ rec.get("Age","â€”") }}</span>
          <span class="dot">â€¢</span>
          <span>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: {{ rec.get("Phone","â€”") }}</span>
          {% if rec.get("Blood Type") %}
          <span class="dot">â€¢</span>
          <span>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: {{ rec.get("Blood Type") }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <hr class="soft-divider">

    <!-- âœ… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (ØªÙƒÙˆÙ† Ù…Ø®ÙÙŠØ© Ø¥Ù„Ù‰ Ø£Ù† ÙŠÙ†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚) -->
    <div class="grid-two details-wrap">
      <!-- Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© -->
      <div class="section">
        <h3 class="sec-title">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©</h3>
        {% set inf = (rec.get("Inferred Conditions","") or "").strip() %}
        {% if inf %}
        <div class="tag-list">
          {% for item in inf.split("ØŒ") if item.strip() %}
          <span class="tag">{{ item.strip() }}</span>
          {% endfor %}
        </div>
        {% else %}
        <span class="tag tag-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
        {% endif %}
      </div>

      <!-- Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© -->
<div class="section">
  <h3 class="sec-title">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</h3>

  {% if meds_photo_url %}
    <!-- Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØ±Ø©: Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© -->
    <ol class="meds-list">
      <li>ğŸ’Š Ø¯Ø§ÙŠÙ…ÙˆÙƒØ³Ø§Ù…ÙŠØ¯ (Diamoxamide â€“ Acetazolamide 250 mg)</li>
      <li>ğŸ’Š Ù†ÙˆØ±Ø£ÙƒØªÙˆÙ† (Noractone â€“ Spironolactone 25 mg)</li>
      <li>ğŸ’Š Ø¥Ù†ØªØ±ÙŠØ³ØªÙˆ (Entresto â€“ Sacubitril/Valsartan 50 mg)</li>
      <li>ğŸ’Š Ù…ÙŠØªÙˆÙ„ÙŠÙ†Ø§ (Metolina â€“ Metoprolol Tartrate 50 mg)</li>
      <li>ğŸ’Š Ø¨Ø§ÙƒÙˆÙƒØ³Ù† (Bakoxin â€“ Digoxin 0.25 mg)</li>
    </ol>
  {% else %}
    <!-- Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©: Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
    {% set meds_text = (rec.get("Current Meds","") or "").strip() %}
    {% if meds_text %}
      <div class="tag-list">
        <span class="tag">{{ meds_text }}</span>
      </div>
    {% else %}
      <span class="tag tag-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
    {% endif %}
  {% endif %}
</div>

      <!-- ØµÙˆØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡ -->
      <div class="section">
        <h3 class="sec-title">ØµÙˆØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡</h3>
        {% if rec.get("Meds Photo") %}
        <img src="{{ url_for('uploaded_file', fname=rec['Meds Photo']) }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡"
          style="width:180px; border-radius:12px; border:1px solid #e5e7eb;">
        {% else %}
        <!-- <div class="muted">Ù„Ù… ØªÙØ±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø¯ÙˆØ§Ø¡</div> -->
        {% endif %}
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ -->
    <div class="sheet-actions">
      <!-- Ø²Ø± Ø·ÙŠØ¨ (ÙŠÙƒØ´Ù Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚) -->
      <button class="btn btn-ok" id="okBtn" type="button" style="margin-right:auto;">ÙØ±ÙŠÙ‚ Ø·ÙÙŠØ¨</button>

      <button class="btn btn-danger" id="panicBtn" type="button">Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© / Ø§Ù„Ø¯Ø¹Ù…</button>
      <button class="btn btn-dark" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

  </div>
</section>

<!-- ÙˆØ§ØªØ³Ø§Ø¨ + Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
<script>
  (function () {
    const SUPPORT_NUMBER = "966543483543"; // â† ØºÙŠÙ‘Ø±ÙŠÙ‡
    let detailsUnlocked = false;

    // Ø£Ø®ÙÙ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ùˆ Ø§Ù„CSS Ù…Ø§ ØªÙØ·Ø¨Ù‘Ù‚ Ù„Ø£ÙŠ Ø³Ø¨Ø¨)
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.details-wrap').forEach(el => {
        el.style.display = 'none';
      });
    });

    function buildMessage({ mode = 'basic', withLocation, lat, lon } = {}) {
      const name  = "{{ rec.get('Full Name', 'â€”') }}";
      const nusuk = "{{ rec.get('Nusuk ID', 'â€”') }}";
      const age   = "{{ rec.get('Age', 'â€”') }}";
      const nat   = "{{ rec.get('Nationality', 'â€”') }}";
      const phone = "{{ rec.get('Phone', 'â€”') }}";
      const blood = "{{ rec.get('Blood Type', 'â€”') }}";
      const meds  = `{{ rec.get('Current Meds', 'â€”') }}`.replace(/\n/g, ', ');
      const inf   = `{{ rec.get('Inferred Conditions', 'â€”') }}`.replace(/\n/g, ', ');

      let msg =
        `ğŸš¨ *Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„ Ù„Ø­Ø§Ø¬*\n\n` +
        `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
        `ğŸªª Ø±Ù‚Ù… Ù†Ø³Ùƒ: ${nusuk}\n` +
        `ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: ${nat}\n` +
        `ğŸ‚ Ø§Ù„Ø¹Ù…Ø±: ${age}\n`;

      if (mode === 'full') {
        msg +=
          `ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${phone}\n` +
          (blood && blood !== "â€”" ? `ğŸ©¸ ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: ${blood}\n` : "") +
          (inf   && inf   !== "â€”" ? `\nğŸ§© *Ø£Ù…Ø±Ø§Ø¶ Ù…Ø­ØªÙ…Ù„Ø©:* ${inf}\n` : "") +
          (meds  && meds  !== "â€”" ? `ğŸ’Š *Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:* ${meds}\n` : "");
      }

      if (withLocation && lat && lon) {
        msg += `\nğŸ“ *Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø¬:* https://www.google.com/maps?q=${lat},${lon}\n`;
      } else {
        msg += `\nâš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹.\n`;
      }
      msg += `\nğŸ”´ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ù‹Ø§.`;
      return msg;
    }

    function openWhatsApp(message, targetWin) {
      const encoded = encodeURIComponent(message);
      const urlApp = `whatsapp://send?phone=${SUPPORT_NUMBER}&text=${encoded}`;
      const urlWeb = `https://wa.me/${SUPPORT_NUMBER}?text=${encoded}`;
      try { (targetWin || window).location.href = urlApp; } catch (e) {}
      setTimeout(() => { try { (targetWin || window).location.href = urlWeb; } catch (e) {} }, 900);
    }

    // Ø²Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
    document.getElementById('panicBtn')?.addEventListener('click', () => {
      const modeToUse = (detailsUnlocked ? 'full' : 'basic');
      const send = (lat = null, lon = null) => {
        const msg = buildMessage({ mode: modeToUse, withLocation: !!(lat && lon), lat, lon });
        openWhatsApp(msg, window);
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => send(pos.coords.latitude.toFixed(6), pos.coords.longitude.toFixed(6)),
          _   => send(),
          { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
        );
      } else {
        send();
      }
    });

    // Ø²Ø± "Ø·ÙŠØ¨" â†’ ÙØªØ­ Ø¨ÙˆØ¨-Ø£Ø¨ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ø«Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.getElementById('okBtn')?.addEventListener('click', showPopup);

    function showPopup() {
      const overlay = document.createElement("div");
      overlay.style.cssText = `
        position:fixed; inset:0; background:rgba(0,0,0,.7);
        display:flex; align-items:center; justify-content:center; z-index:9999;
      `;
      overlay.innerHTML = `
        <div style="
          background:#fff; padding:30px; border-radius:20px;
          box-shadow:0 10px 40px rgba(0,0,0,.3); text-align:center;
          max-width:320px; width:90%; font-family:'Tajawal',sans-serif;
        ">
          <h2 style="margin-bottom:14px; font-size:20px;">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h2>
          <p style="margin-bottom:16px; color:#444;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
          <input type="password" id="idInput" placeholder="â€¢â€¢â€¢â€¢â€¢"
            style="width:100%; padding:10px; border:1px solid #ccc; border-radius:12px; text-align:center; font-size:16px;">
          <div id="errorMsg" style="color:#ef4444; margin-top:8px; display:none;">âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­</div>
          <button id="submitId"
            style="margin-top:16px; background:#0f766e; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer;">
            ØªØ­Ù‚Ù‚
          </button>
        </div>
      `;
      document.body.appendChild(overlay);

      const correctCode = "99999";
      const doCheck = () => {
        const input = document.getElementById("idInput").value.trim();
        const error = document.getElementById("errorMsg");
        if (input === correctCode) {
          overlay.remove();
          // Ø£Ø¸Ù‡Ø± ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
          document.querySelectorAll('.details-wrap').forEach(el => {
            el.style.display = '';          // Ù†Ø¸Ù‘Ù inline style Ø¥Ù† ÙˆÙØ¬Ø¯
            el.classList.add('reveal');     // ÙŠÙØ¹Ù„ grid Ù…Ù† CSS
          });
          // Ø§Ø®ÙÙ Ø²Ø± Ø·ÙŠØ¨ ÙˆÙØ¹Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
          document.getElementById('okBtn')?.remove();
          detailsUnlocked = true;
        } else {
          error.style.display = "block";
          setTimeout(() => { error.style.display = "none"; }, 1600);
        }
      };

      document.getElementById("submitId").addEventListener("click", doCheck);
      document.getElementById("idInput").addEventListener("keyup", e => { if (e.key === "Enter") doCheck(); });
      document.getElementById("idInput").focus();
    }
  })();
</script>


<style>
  /* ===== PERSON PAGE LAYOUT ===== */
  .person-wrap {
    margin-top: 10px;
  }

  .person-heading {
    text-align: center;
    font-size: 28px;
    font-weight: 900;
    margin: 0 0 10px;
    color: #34B8EC;
  }

  .center-badge {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
  }

  .center-badge img {
    height: 56px;
    width: auto;
  }

  .person-sheet {
    position: relative;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 28px;
    padding: 22px 20px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, .08);
    z-index: 50;
  }

  /* Ø²Ø± Ø·ÙŠØ¨ Ø¨Ù„ÙˆÙ†Ùƒ */
  .btn-ok {
    background: #34B8EC;
    color: #fff;
    border: 1px solid #34B8EC;
    box-shadow: 0 6px 16px rgba(52, 184, 236, .28);
    border-radius: 16px;
    padding: 10px 16px;
    font-weight: 900;
    cursor: pointer;
  }

  .btn-ok:hover {
    background: #1fa7df;
    border-color: #1fa7df;
  }

  .basic-info {
    margin-bottom: 16px;
    background: #f9fafb;
    border-radius: 16px;
    padding: 16px;
    border: 1px solid #e5e7eb;
  }

  /* header block */
  .header-row {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 16px;
    align-items: center;
  }

  .left-flag {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .flag {
    width: 62px;
    height: 42px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }

  .flag.fallback {
    width: 62px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f1f5f9;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 22px;
  }

  .nat-label {
    font-weight: 800;
    color: #111827;
  }

  .id-block .name {
    font-size: 22px;
    font-weight: 900;
    line-height: 1.25;
  }

  .id-block .subline {
    margin-top: 6px;
    color: #374151;
    font-weight: 700;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    direction: rtl;
  }
  .meds-list{
  margin: 0;
  padding-inline-start: 1.2rem;
  line-height: 1.7;
  color:#374151;
  font-weight:700;
}

  .subline span {
    white-space: nowrap;
  }

  .subline .dot {
    opacity: .5;
    margin: 0 2px;
  }

  .soft-divider {
    border: none;
    border-top: 1px solid #eef2f7;
    margin: 14px 0 12px;
  }

  /* sections grid (Ø§Ù„Ù…Ø®ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹) */
  .grid-two {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 18px;
  }

  .sec-title {
    font-size: 20px;
    font-weight: 900;
    margin: 0 0 8px;
    color: #111827;
  }

  /* ØªØ£Ø«ÙŠØ± ÙƒØ´Ù Ù„Ø·ÙŠÙ */
  .reveal {
    animation: fadeIn .3s ease-out both;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* tag boxes */
  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag {
    background: #ecfeff;
    color: #0369a1;
    border: 1.5px solid #67e8f9;
    padding: 6px 12px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 14px;
  }

  .tag-empty {
    background: #f3f4f6;
    border-color: #e5e7eb;
    color: #6b7280;
  }

  /* dot lists */
  .dot-list {
    margin: 0;
    padding-inline-start: 1.2rem;
  }

  .dot-list li {
    margin: 6px 0;
  }

  /* bottom actions */
  .sheet-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
  }

  .btn {
    border-radius: 16px;
    padding: 10px 16px;
    font-weight: 900;
    border: 1px solid transparent;
    cursor: pointer;
  }

  .btn-dark {
    background: #111827;
    color: #fff;
  }

  .btn-dark:hover {
    background: #0b1220;
  }

  .btn-danger {
    background: #ef4444;
    color: #fff;
    box-shadow: 0 10px 20px rgba(239, 68, 68, .24);
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .card.glass {
    background: rgba(255, 255, 255, .75);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, .55);
  }

  .nusuk-box {
    position: absolute;
    left: 24px;
    top: 18px;
    background: #ecfeff;
    color: #0369a1;
    border: 2px solid #34B8EC;
    border-radius: 14px;
    padding: 6px 16px;
    font-weight: 800;
    font-size: 16px;
    box-shadow: 0 2px 6px rgba(3, 105, 161, .12);
    white-space: nowrap;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .person-sheet {
      padding: 16px 14px;
      border-radius: 20px;
      overflow: hidden;
    }

    .person-heading {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .header-row {
      grid-template-columns: 1fr;
      gap: 10px;
      align-items: flex-start;
    }

    .nusuk-box {
      position: relative;
      left: auto;
      top: auto;
      margin: 6px 0 4px;
      display: inline-block;
      font-size: 15px;
    }

    .id-block .name {
      font-size: 20px;
    }

    .grid-two {
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .sec-title {
      font-size: 18px;
    }

    .tag {
      font-size: 13px;
      padding: 6px 10px;
    }

    .sheet-actions {
      flex-direction: column;
      gap: 8px;
    }

    .sheet-actions .btn {
      width: 100%;
      text-align: center;
    }
  }

  @media print {

    header.nav,
    .footer {
      display: none !important;
    }

    body {
      background: #fff !important;
    }

    .person-sheet {
      box-shadow: none;
      border: 1px solid #ddd;
    }

    .sheet-actions {
      display: none !important;
    }
  }
</style>

{% endblock %}