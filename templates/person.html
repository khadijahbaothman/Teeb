{% extends 'base.html' %}
{% block title %}Ù…Ù„Ø®Øµ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ{% endblock %}

{% block content %}

<section class="person-wrap">

  <!-- Ø´Ø§Ø±Ø© ÙˆØ³Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: static/badge.png) -->
  <div class="center-badge">
    <img src="{{ url_for('static', filename='badge.png') }}" alt="badge" onerror="this.style.display='none'">
  </div>

  <!-- Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="person-sheet card glass">
    <h1 class="person-heading">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ </h1>
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø¹Ù„Ù… + Ø¬Ù†Ø³ÙŠØ© | Ø§Ø³Ù… + Ø±Ù‚Ù… Ù†Ø³Ùƒ | Ø£ÙØ§ØªØ§Ø± -->
    <div class="header-row">
      <div class="left-flag">
        {% if flag_url %}
          <img class="flag" src="{{ flag_url }}" alt="flag" crossorigin="anonymous" referrerpolicy="no-referrer">
        {% else %}
          <div class="flag fallback">ğŸŒ</div>
        {% endif %}
        <div class="nat-label">{{ rec.get("Nationality","â€”") }}</div>
      </div>

      <div class="id-block">
        <div class="name">{{ rec.get("Full Name","â€”") }}</div>
        <div class="nusuk-box">
          Ø±Ù‚Ù… Ù†Ø³Ùƒ: {{ rec.get("Nusuk ID","â€”") }}
        </div>
        <div class="subline" dir="rtl">
          <span>Ø§Ù„Ø¹Ù…Ø±: {{ rec.get("Age","â€”") }}</span>
          <span class="dot">â€¢</span>
          <span>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: {{ rec.get("Phone","â€”") }}</span>
          {% if rec.get("Blood Type") %}
            <span class="dot">â€¢</span>
            <span>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: {{ rec.get("Blood Type") }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <hr class="soft-divider">

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
    <div class="grid-two">
      <!-- Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© -->
      <div class="section">
        <h3 class="sec-title">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©</h3>
        <div class="tag-list">
          {% set chronic_str = rec.get("Chronic Conditions","") %}
          {% set any_tag = False %}
          {% for raw in chronic_str.split("ØŒ") if raw.strip() %}
            {% set any_tag = True %}
            {% set item = raw.strip() %}
            {% if item.startswith("Ø£Ø®Ø±Ù‰") %}
              {% set parts = item.split(":", 1) %}
              {% set val = parts[1].strip() if parts|length > 1 else "Ø£Ø®Ø±Ù‰" %}
              <span class="tag">{{ val }}</span>
            {% else %}
              <span class="tag">{{ item }}</span>
            {% endif %}
          {% endfor %}
          {% if not any_tag %}
            <span class="tag tag-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
          {% endif %}
        </div>
      </div>

      <!-- Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© -->
      <div class="section">
        <h3 class="sec-title">Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©</h3>
        <div class="tag-list">
          {% set allergies_str = rec.get("Allergies","") %}
          {% set any_tag = False %}
          {% for raw in allergies_str.split("ØŒ") if raw.strip() %}
            {% set any_tag = True %}
            {% set item = raw.strip() %}
            {% if item.startswith("Ø£Ø®Ø±Ù‰") %}
              {% set parts = item.split(":", 1) %}
              {% set val = parts[1].strip() if parts|length > 1 else "Ø£Ø®Ø±Ù‰" %}
              <span class="tag">{{ val }}</span>
            {% else %}
              <span class="tag">{{ item }}</span>
            {% endif %}
          {% endfor %}
          {% if not any_tag %}
            <span class="tag tag-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
          {% endif %}
        </div>
      </div>

      <!-- Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
      <div class="section">
        <h3 class="sec-title">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <ul class="dot-list">
          {% for line in (rec.get("Current Meds","").splitlines()) if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
          {% if not rec.get("Current Meds") %}<li class="muted">â€”</li>{% endif %}
        </ul>
      </div>

      <!-- Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª -->
      <div class="section">
        <h3 class="sec-title">Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª</h3>
        <ul class="dot-list">
          {% for line in (rec.get("Vaccinations","").splitlines()) if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
          {% if not rec.get("Vaccinations") %}<li class="muted">â€”</li>{% endif %}
        </ul>
      </div>
    </div>

    {% if rec.get("Medical Notes") %}
      <div class="section">
        <h3 class="sec-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©</h3>
        <ul class="dot-list">
          {% for line in rec.get("Medical Notes","").splitlines() if line.strip() %}
            <li>{{ line.strip() }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ -->
    <div class="sheet-actions">
      <button class="btn btn-danger" id="panicBtn" type="button">
        Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© / Ø§Ù„Ø¯Ø¹Ù…
      </button>
      <button class="btn btn-dark" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

  </div>
</section>

<script>
  document.getElementById('panicBtn')?.addEventListener('click', () => {
    const supportNumber = "966555000000"; // ØºÙŠÙ‘Ø±ÙŠÙ‡ Ù„Ø±Ù‚Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
  
    const name = "{{ rec.get('Full Name', 'â€”') }}";
    const nusuk = "{{ rec.get('Nusuk ID', 'â€”') }}";
    const age = "{{ rec.get('Age', 'â€”') }}";
    const nationality = "{{ rec.get('Nationality', 'â€”') }}";
    const phone = "{{ rec.get('Phone', 'â€”') }}";
    const blood = "{{ rec.get('Blood Type', 'â€”') }}";
    const chronic = `{{ rec.get('Chronic Conditions', 'â€”') }}`.replace(/\n/g, ', ');
    const allergy = `{{ rec.get('Allergies', 'â€”') }}`.replace(/\n/g, ', ');
    const meds = `{{ rec.get('Current Meds', 'â€”') }}`.replace(/\n/g, ', ');
  
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
  
          const message =
            `ğŸš¨ *Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„ Ù„Ø­Ø§Ø¬*\n\n` +
            `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
            `ğŸªª Ø±Ù‚Ù… Ù†Ø³Ùƒ: ${nusuk}\n` +
            `ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${phone}\n` +
            `ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: ${nationality}\n` +
            `ğŸ§â€â™‚ï¸ Ø§Ù„Ø¹Ù…Ø±: ${age}\n` +
            (blood && blood !== "â€”" ? `ğŸ©¸ ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: ${blood}\n` : "") +
            `\nâš•ï¸ *Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©:* ${chronic}\n` +
            `ğŸ’Š *Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:* ${meds}\n` +
            `ğŸŒ¿ *Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:* ${allergy}\n\n` +
            `ğŸ“ *Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø¬:* ${mapsLink}\n\n` +
            `ğŸ”´ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ù‹Ø§.`;
  
          const waURL = `https://wa.me/${supportNumber}?text=${encodeURIComponent(message)}`;
          window.open(waURL, "_blank");
        },
        (error) => {
          alert("Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.");
          sendWithoutLocation();
        }
      );
    } else {
      alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.");
      sendWithoutLocation();
    }
  
    function sendWithoutLocation() {
      const message =
        `ğŸš¨ *Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„ Ù„Ø­Ø§Ø¬ (Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹)*\n\n` +
        `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
        `ğŸªª Ø±Ù‚Ù… Ù†Ø³Ùƒ: ${nusuk}\n` +
        `ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${phone}\n` +
        `ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: ${nationality}\n` +
        `ğŸ§â€â™‚ï¸ Ø§Ù„Ø¹Ù…Ø±: ${age}\n` +
        (blood && blood !== "â€”" ? `ğŸ©¸ ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: ${blood}\n` : "") +
        `\nâš•ï¸ *Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©:* ${chronic}\n` +
        `ğŸ’Š *Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:* ${meds}\n` +
        `ğŸŒ¿ *Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:* ${allergy}\n\n` +
        `âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹.`
  
      const waURL = `https://wa.me/${supportNumber}?text=${encodeURIComponent(message)}`;
      window.open(waURL, "_blank");
    }
  });
  </script>

<style>
/* ===== PERSON PAGE LAYOUT (inline for convenience) ===== */
.person-wrap{ margin-top: 10px; }
.person-heading{ text-align:center; font-size:28px; font-weight:900; margin:0 0 10px; color: #34B8EC;}
.center-badge{ display:flex; justify-content:center; margin-bottom:10px; }
.center-badge img{ height:56px; width:auto; }

.person-sheet{
  position: relative;
  background:#fff; border:1px solid var(--border);
  border-radius:28px; padding:22px 20px;
  box-shadow:0 18px 40px rgba(0,0,0,.08);
  z-index: 50;
}

/* header block */
.header-row{
  display:grid; grid-template-columns: 140px 1fr 70px; gap:16px; align-items:center ;
}
.left-flag{ display:flex; align-items:center; gap:10px; }
.flag{ width:62px; height:42px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb; }
.flag.fallback{ width:62px; height:42px; display:flex; align-items:center; justify-content:center; background:#f1f5f9; border:1px solid #e5e7eb; border-radius:6px; font-size:22px; }
.nat-label{ font-weight:800; color:#111827; }

.id-block .name{ font-size:22px; font-weight:900; line-height:1.25;}
.id-block .hid{ color:#6b7280; font-weight:700; margin-top:4px; }
.id-block .subline{ margin-top:6px; color:#374151; font-weight:700; display:flex; gap:8px; flex-wrap:wrap; }
.subline .dot{ opacity:.5 }

.avatar{
  width:54px; height:54px; border-radius:50%;
  background:#f3f4f6; display:flex; align-items:center; justify-content:center;
  font-size:24px; border:1px solid #e5e7eb;
}
.id-block .subline{
  direction: rtl;              /* ÙŠØ¶Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠÙ…ÙŠÙ†â†’ÙŠØ³Ø§Ø± */
  display:flex; flex-wrap:wrap;
  gap: 12px;                   /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
  color:#374151; font-weight:700; margin-top:6px;
}
.subline span{ white-space: nowrap; }
.subline .dot{ opacity:.5; margin: 0 2px; }

.soft-divider{ border:none; border-top:1px solid #eef2f7; margin:14px 0 12px; }

/* sections grid */
.grid-two{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:18px; }
.sec-title{ font-size:20px; font-weight:900; margin:0 0 8px; color:#111827; }

/* tag boxes (pills) */
.tag-list{ display:flex; flex-wrap:wrap; gap:8px; }
.tag{
  background:#ecfeff; color:#0369a1; border:1.5px solid #67e8f9;
  padding:6px 12px; border-radius:999px; font-weight:800; font-size:14px;
}
.tag-empty{ background:#f3f4f6; border-color:#e5e7eb; color:#6b7280; }

/* dot lists */
.dot-list{ margin:0; padding-inline-start: 1.2rem; }
.dot-list li{ margin:6px 0; }

/* bottom actions */
.sheet-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:16px; }
.btn{ border-radius:16px; padding:10px 16px; font-weight:900; border:1px solid transparent; cursor:pointer; }
.btn-dark{ background:#111827; color:#fff; }
.btn-dark:hover{ background:#0b1220; }
.btn-danger{ background:#ef4444; color:#fff; box-shadow:0 10px 20px rgba(239,68,68,.24); }
.btn-danger:hover{ background:#dc2626; }

.card.glass {
  background: rgba(255, 255, 255, .75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, .55);
}

.nusuk-box {
  position: absolute;
  left: 24px;
  top: 18px;
  background: #ecfeff;
  color: #0369a1;
  border: 2px solid #34B8EC;
  border-radius: 14px;
  padding: 6px 16px;
  font-weight: 800;
  font-size: 16px;
  box-shadow: 0 2px 6px rgba(3,105,161,.12);
  white-space: nowrap; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø§Ù†Ù‚Ø³Ø§Ù… */
}

/* ğŸ¯ ØªØ¹Ø¯ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 640px) {
  .nusuk-box {
    position: relative;  /* ÙŠØ®Ù„ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¯ÙÙ‚ Ø¨Ø¯Ù„ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
    left: auto;
    top: auto;
    margin: 10px auto 6px auto; /* ÙŠÙˆØ³Ù‘Ø·Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø§Ø³Ù… */
    display: inline-block;
    font-size: 15px;
  }
}
/* responsive */
@media (max-width: 820px){
  .header-row{ grid-template-columns: 1fr 1fr; }
  .avatar{ grid-column: 2 / 3; justify-self:end; }
  .grid-two{ grid-template-columns: 1fr; }
}

/* print clean */
@media print{
  header.nav, .footer { display:none !important; }
  body{ background:#fff !important; }
  .person-sheet{ box-shadow:none; border:1px solid #ddd; }
  .sheet-actions{ display:none !important; }
}
/* ===== Mobile & small screens fixes ===== */
@media (max-width: 640px){
  /* Ø§Ù„ÙƒØ±Øª Ù†ÙØ³Ù‡ */
  .person-sheet{
    padding: 16px 14px;
    border-radius: 20px;
    overflow: hidden;
  }

  /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
  .person-heading{ font-size: 24px; margin-bottom: 6px; }

  /* Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø®Ù„ÙŠÙ‡ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ */
  .header-row{
    grid-template-columns: 1fr;
    gap: 10px;
    align-items: flex-start;
  }

  /* ØµÙ†Ø¯ÙˆÙ‚ Ø±Ù‚Ù… Ù†Ø³Ùƒ: Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¯ÙÙ‚ ÙˆØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© */
  .nusuk-box{
    position: relative;
    left: auto; top: auto;
    margin: 6px 0 4px 0;
    display: inline-block;
    font-size: 15px;
  }

  /* Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¹Ø±Ù‘Ù */
  .id-block .name{ font-size: 20px; }
  .id-block .hid{ font-size: 13px; }

  /* Ø³Ø·Ø± (Ø§Ù„Ø¹Ù…Ø± â€¢ Ø§Ù„Ø¬ÙˆØ§Ù„ â€¢ Ø§Ù„Ø¯Ù…) */
  .id-block .subline{
    font-size: 14px;
    gap: 8px;
    flex-wrap: wrap;
  }
  .id-block .subline span{ white-space: nowrap; } /* ÙŠÙ…Ù†Ø¹ ØªÙƒØ³ÙŠØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª */

  /* Ø§Ù„Ø¹Ù„Ù… ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ© */
  .left-flag{ order: 3; justify-content: flex-start; }
  .flag{ width: 56px; height: 36px; }

  /* Ø§Ù„ÙØ§ØµÙ„ */
  .soft-divider{ margin: 10px 0; }

  /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ */
  .grid-two{ grid-template-columns: 1fr; gap: 14px; }

  /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„ØªØ§ØºØ§Øª Ø£ØµØºØ± */
  .sec-title{ font-size: 18px; }
  .tag{ font-size: 13px; padding: 6px 10px; }
  .tag-list{ gap: 6px; }

  /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù†Ù‚Ø·ÙŠØ© */
  .dot-list{ padding-inline-start: 1rem; }

  /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ ØªÙ…ØªÙ„Ø¦ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØªØªØ±ØªØ¨ Ø¹Ù…ÙˆØ¯ÙŠ */
  .sheet-actions{
    flex-direction: column;
    gap: 8px;
  }
  .sheet-actions .btn{
    width: 100%;
    text-align: center;
  }
}

/* ØªØ§Ø¨Ù„Øª ØµØºÙŠØ± */
@media (min-width: 641px) and (max-width: 820px){
  .person-sheet{ padding: 18px 16px; }
  .header-row{ grid-template-columns: 140px 1fr; }
  .grid-two{ grid-template-columns: 1fr 1fr; gap: 16px; }
  .tag{ font-size: 13.5px; }
}
</style>

{% endblock %}